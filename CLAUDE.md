# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際にClaude Code (claude.ai/code) にガイダンスを提供します。

## プロジェクト概要

wavgoは、PCMフォーマットサポートを持つWAVオーディオファイルの読み書きを行うGoライブラリです。WAVファイルヘッダーの解析、オーディオサンプルの抽出、新しいWAVファイルの作成のためのシンプルなAPIを提供します。

## 主な機能

- WAVヘッダーの解析とフォーマット情報へのアクセス
- 一般的なビット深度でのサンプルデータの読み取り
- カスタムフォーマットでの新しいWAVファイルの書き込み

## 開発コマンド

### テスト

- `go test -v` - 詳細出力で全テストを実行
- `go test ./...` - サブディレクトリを含む全パッケージのテストを実行
- `go test -run TestReader` - 特定のテスト関数を実行

### コード品質

- `go vet ./...` - 潜在的な問題を検出する静的解析を実行
- `go fmt ./...` - 全Goソースファイルをフォーマット
- `go mod tidy` - モジュール依存関係をクリーンアップ

### ビルド

- `go build` - ライブラリをコンパイル（ライブラリのためバイナリは生成されない）
- `go install` - 他のGoプログラムで使用するためにパッケージをインストール

## アーキテクチャ

### コアコンポーネント

**Reader** (`reader.go`):
- RIFFチャンク処理を介したWAVファイル解析を処理
- `Load()`メソッドを使用してファイル全体をメモリに読み込んで処理
- FMTチャンクからフォーマット情報（サンプルレート、チャンネル、ビット深度）を抽出
- 8/16/24/32ビット深度をサポートしてDATAチャンクからオーディオサンプルを読み取り
- シーケンシャル読み取りのために残りサンプル数を追跡
- 改善されたエラーハンドリングと`Close()`メソッドの戻り値

**Writer** (`writer.go`):
- 指定されたフォーマットパラメータでWAVファイルを作成
- 最初の`WriteSamples()`呼び出し時に遅延ヘッダー書き込み
- RIFFとDATAチャンクサイズ更新のためのファイルオフセットを維持
- 有効なWAV構造のために`Close()`メソッドでチャンクサイズを更新
- ファイル同期とエラーハンドリングの改善

**RIFF Parser** (`internal/riff/`):
- `reader.go`: RIFFファイル構造をチャンクに解析
- `riff.go`: チャンク構造を定義し、チャンク検索メソッドを提供
- RIFFコンテナからのFMTとDATAチャンクの抽出を処理

**バイナリI/O** (`internal/binio/`):
- カスタムバイナリリーダー/ライター実装
- `encoding/binary`パッケージを使用したエンディアン処理
- ファイルオフセット管理とエラー追跡

### 主要な設計パターン

- **Binary I/O**: 内部の`binio`パッケージでリトルエンディアン/ビッグエンディアンデータ処理
- **エラーハンドリング**: 定義済みエラー変数と一貫したエラー伝播
- **リソース管理**: ファイルハンドルは明示的な`Close()`呼び出しが必要（エラーを返すように改善）
- **サンプルフォーマット**: オーディオデータ用の固定ステレオ`Sample [2]int`タイプ
- **遅延書き込み**: Writerは最初のサンプル書き込みまでヘッダー作成を遅延
- **独立性**: 外部バイナリI/O依存関係を内部実装で置き換え

### 依存関係

- `github.com/stretchr/testify` - テストアサーションとテストユーティリティ
- `encoding/binary` - 標準ライブラリのバイナリエンコーディング

### エラー定義

- `ErrUnsupportedBitsPerSample` - サポートされていないビット深度エラー

### テストデータ

- `testdata/read_test.wav` - リーダーテスト用サンプルWAVファイル
- `testdata/write_test.wav.golden` - ライターテスト用期待出力
